#!/bin/bash

RED="\e[31m"
GREEN="\e[32m"
ENDCOLOR="\e[0m"

# Get the local version in the staged package.json file
LOCAL_VERSION=$(git show :package.json | grep '"version":' | cut -d '"' -f 4)

# Get the remote version in the package.json file of the branch you're pushing to
REMOTE_BRANCH=$(git symbolic-ref -q --short HEAD)
REMOTE_VERSION=$(git show "origin/$REMOTE_BRANCH:package.json" | grep '"version":' | cut -d '"' -f 4)

echo "Running pre-push hook"

# Function to compare two versions using npm version
version_compare() {
    local local_version="$1"
    local remote_version="$2"
    local result
    result=$(npm --no-git-tag-version --no-commit-hooks --json version "$local_version" "$remote_version")
    if [[ "$result" =~ "\"diff\":\\{\"versions\":"(.+) ]]; then
        diff=$(echo "${BASH_REMATCH[1]}" | tr -d '[:space:]')
        if [ "$diff" == "null" ]; then
            return 0
        fi
    fi
    return 1
}

# Check if the local version is higher than the remote version
if version_compare "$LOCAL_VERSION" "$REMOTE_VERSION"; then
    echo "Local package.json version ($LOCAL_VERSION) is higher than the remote version ($REMOTE_VERSION). Proceeding with the push..."
else
    echo -e "${RED}Error: Local package.json version ($LOCAL_VERSION) is not higher than the remote version ($REMOTE_VERSION). Pushing on a lower or equal version is not allowed.${ENDCOLOR}"
    exit 1
fi
